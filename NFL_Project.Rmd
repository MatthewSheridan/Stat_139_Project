---
title: "R Notebook"
output: pdf_document
---


```{r}
install.packages("tidyverse", type = "binary")
install.packages("ggrepel", type = "binary")
install.packages("ggimage", type = "binary")
install.packages("nflfastR", type = "binary")
install.packages("dplyr", type = "binary")
```

```{r}
library(tidyverse)
library(ggrepel)
library(ggimage)
library(nflfastR)
library(dplyr)
options(scipen = 9999)
```

```{r}
cleaned = data.frame()
data <- load_pbp(2020)

sum(data[data$posteam == "NE" & data$pass==1,]$yards_gained)
data[(data$posteam == "NE"),]$home_score

        
        
for (i in unique(data$game_id)){
  home = data[data$game_id == i,]$home_team
  away = data[data$game_id == i,]$away_team
  #home_data = c(sum(data[data$posteam == home & data$pass==1,]$yards_gained, na.rm=T))
  print((sum(data[data$game_id == i & data$posteam == home & data$pass==1,]$yards_gained, na.rm=T)))
}
#252

data[data$game_id=="2020091311" & data$posteam==data$home_team & data$pass==1, ]

head(data)
```


```{r}
data19 <- load_pbp(2019)
data20 <- load_pbp(2020)
#head(data1$game_id,100)

#unique(data1$game_id)
clean = function(data1){
  names = c("Game_id","Team_Name","Home","TFL", "QB_Hit", "Pass_Yrd","Rush_Yrd",
            "TD","FG_attempt","XP_missed","FG_missed","FUM","INT","4th_Dwn_Con","3rd_Dwn_Con","Pen", "Score_Dif")
  
  df <- data.frame()
  
  for(i in unique(data1$game_id)) {
    temp <- subset(data1, game_id == i)
    for(j in c(temp$home_team[1], temp$away_team[1])) {
      to_add <- c(i, #Game id
                  j, #team name
                  1*(j==temp$home_team[1]), #team is home
                  sum(temp$tackled_for_loss[temp$defteam == j] == 1, na.rm=TRUE), #tackles for loss
                  sum(temp$qb_hit[temp$posteam == j] == 1, na.rm=TRUE), #how many times team's QB was hit
                  sum(temp$passing_yards[temp$posteam == j], na.rm=TRUE), #team passing yards
                  sum(temp$rushing_yards[temp$posteam == j], na.rm=TRUE), #team rushing yards
                  sum(temp$touchdown[temp$posteam == j], na.rm=TRUE), #team touchdowns
                  sum(temp$field_goal_attempt[temp$posteam == j], na.rm=TRUE), #team field goal attempts
                  sum(temp$extra_point_result[temp$posteam == j]=="failed" | 
                        temp$extra_point_result[temp$posteam == j]=="blocked", na.rm=TRUE), #exp missed
                  sum(temp$field_goal_result[temp$posteam == j]=="missed" | 
                        temp$field_goal_result[temp$posteam == j]=="blocked", na.rm=TRUE), #fg missed
                  sum(temp$fumble[temp$defteam == j], na.rm=TRUE), #number of fumbles
                  sum(temp$interception[temp$defteam == j], na.rm=TRUE), #number of interceptions
                  sum(temp$fourth_down_converted[temp$posteam == j], na.rm=TRUE), #4th down conversions
                  sum(temp$third_down_converted[temp$posteam == j], na.rm=TRUE), #3rd down conversions
                  sum(temp$penalty[temp$posteam == j & temp$penalty_team == j], na.rm=TRUE), #number of penalties
                  temp$result[1]*ifelse(j==temp$away_team[1], -1, 1) #score differential
                  )
      df <- rbind(df, to_add)
    }
  }
  
  colnames(df) = names
  
  df = df %>% 
  mutate_at(c("Home","TFL", "QB_Hit", "Pass_Yrd","Rush_Yrd",
          "TD","FG_attempt","XP_missed","FG_missed","FUM","INT","4th_Dwn_Con","3rd_Dwn_Con","Pen", "Score_Dif"), as.numeric)
  
  return(df)
}

```


```{r}
#DO EDA HERE
data_2019 = clean(data19)
head(data_2019)
data_2020 = clean(data20)
head(data_2020)
```


```{r}
lm1 = lm(Score_Dif~., data=data_2019[,seq(3, ncol(data_2019))])

summary(lm1)

sqrt(mean((data_2019$Score_Dif-predict(lm1))^2))

sqrt(mean((data_2020$Score_Dif-predict(lm1, newdata = data_2020[,seq(2, ncol(data_2020))]))^2))


```